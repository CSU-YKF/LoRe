## 问题澄清
需要实现的功能是：

针对不同类型的罐车，通过RGB-D相机采集的图像和点云，精确估计加注口和回收口的位姿。
输出包括加注口和回收口的圆心三维坐标和圆面法向量。
位姿估计的精度要求在20mm以内，法向量的角度误差不超过5度。

## 解决方案总体思路
我们将采用RGB-D相机获取的点云数据，通过一系列数据处理步骤，最终得到加注口和回收口的圆心坐标和法向量。
这一过程分为**数据预处理**、**点云分割**、**圆形拟合**、**位姿计算**四个主要步骤。

## 技术路线
1. 数据采集与预处理
   目标: 从RGB-D相机采集的数据中提取有用的点云信息，去除噪声并对数据进行格式化处理。

步骤:

- 数据格式确认：读取提供的点云数据（.pcd 文件），确保它们能被使用的库如PCL (Point Cloud Library) 或 Open3D 正确解析。
- 噪声滤除：使用统计滤波（Statistical Outlier Removal）或体素网格下采样（Voxel Grid Downsampling）来降低点云的噪声和密度，优化处理速度。
然而体素下采样后很容易影响其余算法的性能，例如RANSAC。

- 地面/背景剔除：如果点云数据包含大量不相关的背景数据，可以使用平面分割算法（如RANSAC）将地面或不相关点剔除，仅保留与加注口和回收口相关的点。
然而当点云较稀疏时，使用平面分割算法会将目标（圆平面）错误剔除。所以我们将被剔除的部分和剩余部分都保留。

- 先验式Box过滤
在Outlier的切除过程中，我们有一种比较直接的先验知识，即加注口和回收口的高度应该在一定范围内，可以通过这个先验知识来判断点云是否是噪声点。 
根据模板文件，大致可确定两个加注口的位置为（132.78 104.07 1230.86）（539.87 93.71 1169.73），进行估计后得到为（150 100 1200）（550 100 1200）。
两个加注口的Y坐标相差不大，Z坐标相差不大，X坐标相差较大，因此可以通过这个先验知识来判断点云是否是噪声点。
又考虑到圆形的Y轴，所以将Y轴的数值加大。
设计一组阈值，（200，100，50），即X坐标相差200mm，Y坐标相差100mm，Z坐标相差50mm，超过这个阈值的点云可以认为是噪声点。 
由此设计一个CropBox，将超过阈值的点云剔除。
```cpp
pcl::CropBox<pcl::PointXYZ> boxFilter;
boxFilter.setMin(Eigen::Vector4f(-50, 0, 1100, 1.0));
boxFilter.setMax(Eigen::Vector4f(750, 200, 1300, 1.0));
```
值得注意的是，当我们使用CropBox剔除后，同时也会将NaN值剔除，所以之后没必要再次剔除NaN值。

当然我们也可以采用强先验的技术，一方面我们确定Box的边框，另一方面我们可以确定Box的两个中心点，计算分割出的平面到两个中心点的距离，从而达到拟合的效果。

如果再鲁棒一些，可以设计一套自适应的算法，即最初预定义好中心点和边界框的位置，根据传入的数据进行调整。

我们不难发现，其实一些算法的效果是很差的。

2. 点云分割
   目标: 将加注口和回收口从点云数据中分离出来，以便进一步拟合其位姿。

步骤:

- 点云聚类：使用Euclidean Cluster Extraction算法对点云进行聚类，将罐车的不同结构（如加注口、回收口、罐体等）分离成不同的点云簇。
- 感兴趣区域提取：根据罐车的结构和已知几何布局，对位于加注口和回收口区域的点云进行提取。
我们可以借助ICP算法来进行配准，以确定区域的形状。但是ICP配准的拟合分数很不准确。


3. 几何形状拟合
   目标: 在分割出的点云簇上拟合圆形结构，得到加注口和回收口的位姿。

步骤:

- 圆拟合：使用PCL中的RANSAC或Least Squares Circle Fitting（最小二乘圆拟合）算法，基于点云提取加注口和回收口的圆形边缘，拟合出圆心位置和法向量。
RANSAC适用于含有噪声的数据，它能通过迭代地随机选择点集进行拟合，并找到最优解。
输出为圆心的3D坐标 $(x, y, z)$ 和法向量 $(n_x, n_y, n_z)$。
- 法向量估计：通过拟合圆的点集计算其法向量。如果圆面不平整或有偏差，可以结合主成分分析（PCA）法确定法向量方向。
- 验证与调整：将拟合的圆心坐标与模板数据中的标准加注口和回收口进行比对，确保拟合误差在规定的范围内（20mm以内）。


## 技术细节与实现步骤
### 使用工具

PCL库：用于点云处理，包括噪声滤波、分割、聚类以及几何拟合。
Open3D库：如果想简化实现，Open3D也是一种灵活的点云处理工具库。
RANSAC算法：通过RANSAC进行圆拟合，兼顾鲁棒性与精确性。
PCA（主成分分析）：辅助估计圆面的法向量。

### 算法流程图

采集点云数据 → 预处理 → 点云分割 → 圆拟合 → 位姿估计 → 结果输出

### 性能优化

1. [ ] 使用体素下采样减少点云规模，提高处理速度；
2. [ ] 优化点云分割算法，确保程序在60秒内完成。

### 可视化与验证
可以使用CloudCompare或Open3D可视化估计结果，将拟合的圆心和法向量通过图形界面展示出来。
比如，使用visual1.png、visual2.png验证估计结果，通过查看圆心和法向量在图中的对比效果，确保精度。

## 下一步工作
- 测试数据集：先用实验箱的数据进行测试，验证拟合精度和法向量角度，确保在可接受误差范围内。
- 实车数据处理：成功处理实验数据后，尝试处理真实罐车的点云数据。
- 程序优化：基于测试结果，优化点云分割和拟合算法，进一步提高精度和计算效率。
