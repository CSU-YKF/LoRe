## 问题澄清
需要实现的功能是：

针对不同类型的罐车，通过RGB-D相机采集的图像和点云，精确估计**加注口**和**回收口**的位姿。
输出包括加注口和回收口的**圆心三维坐标**和**圆面法向量**。
位姿估计的精度要求在20mm以内，法向量的角度误差不超过5度。

## 解决方案总体思路
本项目提出的算法名为3D-Age（3D Adaptive Geometry pose Estimate）将仅仅采用RGB-D相机获取的**点云数据**，不依赖图像数据，通过一系列高效准确的数据处理，最终得到加注口和回收口的圆心坐标和法向量。
这一过程分为**数据预处理**、**点云分割**、**圆形拟合**三个主要步骤。

## 技术路线
1. ### 数据采集与预处理
目标: 从RGB-D相机采集的数据中提取有用的点云信息，去除噪声并对数据进行格式化处理。

步骤:
1. 数据格式确认：读取提供的点云数据（.pcd 文件），确保它们能被使用的库如PCL (Point Cloud Library) 或 Open3D 正确解析。
2. 噪声滤除：使用统计滤波（Statistical Outlier Removal）或体素网格下采样（Voxel Grid Downsampling）来降低点云的噪声和密度，优化处理速度。
由于单个文件较大，统计滤波的效率较低，所以我们主要采用体素网络，设置距离阈值为1mm进行基本的下采样。便于后续提升效率。
3. 地面/背景剔除：如果点云数据包含大量不相关的背景数据，我们采用先验式的空间滤波。
我们认为加注口位于整个罐槽车的中心附近，所以可以先计算出罐装中心，接着分别计算出距离中心最远的x坐标、y坐标与z坐标到中心的距离，以及分别计算三个方向到中心的标准差。每个方向在标准差到最大值之间进行3次采样，以采样值作为圆心半径得到三个递增的封闭Box空间。之后并行处理封闭空间，滤除空间外的点云。如此完成了背景剔除。对于进行3次采样，是为了防止直接使用标准差作为半径时滤除掉目标点云，所以进行扩展，收集3个。后续会对3个不同空间内的结果进行优化。
4. 平面检测：使用平面分割算法（如RANSAC）检测空间中的较大平面，我们设置当一个平面的点云数量小于各个平面点云数量平均值时，则删除，以去除小噪声。接着我们统计检测到的各个平面的法向量，保留近似平行于z轴的法向量对应的平面。因为使用深度相机进行检测时，几何目标通常正对相机，所以一般几何目标的法向量是平行于z轴的。

2. ### 点云分割
目标: 将加注口和回收口从点云数据中分离出来，以便进一步拟合其位姿。

步骤:

1. 点云聚类：使用Euclidean Cluster Extraction算法对点云进行聚类，将罐车的不同结构（如加注口、回收口、罐体等）分离成不同的点云簇。借助KDTree加快计算效率，我们设置近邻参数为6以便于从六个方向搜索。
当聚类数量小于n（所需要检测的几何目标数量，这里是2，因为我们只需要加注口和回收口两个），则认为当前封闭空间无效，直接放弃该空间。
2. ICP几何配准：我们计算聚类出的点云簇的平均点数量，使用该平均点数构建一个对应几何形状的点云（这里是圆形），接着借助ICP算法来进行配准，通过配准分数以确定区域的形状。取最好的n（这里是2，因为我们只需要两个圆）个分数认为是本轮配准的结果。比较所有剩余空间中的最好分数是否相同，若分数不同则取更好的。最后只保留一个较小的空间。

3. ### 几何形状拟合
目标: 在分割出的点云簇上拟合圆形结构，得到加注口和回收口的位姿。

圆拟合：使用RANSAC算法，基于点云提取加注口和回收口的圆形边缘，拟合出圆心位置和法向量。
RANSAC适用于含有噪声的数据，它能通过迭代地随机选择点集进行拟合，并找到最优解。
输出为圆心的3D坐标 $(x, y, z)$ 和法向量 $(n_x, n_y, n_z)$。

## 技术细节与实验结果
### 使用工具

PCL库：用于点云处理，包括噪声滤波、分割、聚类以及几何拟合。
CloudCompare：开源的点云处理软件。
Qt：制作可视化界面。

### 性能

大约在1秒处理一个十万点云的文件。
