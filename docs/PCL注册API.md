.. _registration_api:

PCL注册API
------------------------

将多个3D点云数据视图一致地对齐到一个完整模型的问题被称为**配准**。其目标是在全局坐标框架中找到分别获取的视图的相对位置和方向，使它们的交叉区域完美重叠。对于从不同视图获取的每组点云数据集，我们需要一个系统来将它们对齐为单一的点云模型，以便后续的处理步骤如分割和物体重建可以进行。

.. image:: images/registration/scans.jpg
    :align: center

上图展示了一个激励性的例子，其中使用倾斜的2D激光单元获取了六个独立数据集。由于每个独立扫描只代表周围世界的一小部分，因此必须找到将它们配准在一起的方法，从而创建如下面图所示的完整点云模型。

.. image:: images/registration/s1-6.jpg
    :align: center

PCL注册库中的算法工作主要是通过在给定输入数据集中找到正确的点对应关系，并估计刚性变换，将每个独立数据集旋转和转换到一致的全局坐标框架中。如果输入数据集中点的对应关系已知，则此注册范式变得容易解决。这意味着一个数据集中选择的点列表必须在特征表示的角度上与另一个数据集的点列表“重合”。此外，如果估计的对应关系是“完美的”，那么配准问题将有一个封闭形式的解决方案。

PCL包含一组强大的算法，能够估计多组对应关系，并且提供拒绝错误对应关系的机制，同时还能够从中稳健地估计变换。以下部分将分别描述这些步骤。

**配对配准概述**
------------------------------------

有时我们将配准一对点云数据集的问题称为*配对配准*，其输出通常是一个刚性变换矩阵（4x4），表示需要对一个数据集（称为*源*）应用的旋转和平移，以使其与另一个数据集（称为*目标*或*模型*）完美对齐。

*配对配准*的步骤如下图所示。请注意，这里展示的是算法的单次迭代。程序员可以决定是否对所有步骤进行循环。

.. image:: images/registration/block_diagram_single_iteration.jpg
    :align: center

两个数据集的计算步骤如下：

  * 从一组点中识别出最能代表场景的**兴趣点**（即**关键点**）；
  * 在每个关键点处计算**特征描述符**；
  * 根据两个数据集中**特征描述符**及其XYZ位置，基于特征和位置的相似性估计一组**对应关系**；
  * 考虑到数据可能有噪声，并非所有的对应关系都有效，因此需要拒绝那些对配准过程产生负面影响的错误对应关系；
  * 从剩余的良好对应关系集中，估计运动变换。

**配准模块**
--------------------

我们来看一下该管道的各个步骤。

### 关键点

关键点是在场景中具有“特殊属性”的兴趣点，如书的角落或书上写着“PCL”的字母“P”。PCL中有多种不同的关键点可用，如NARF、SIFT和FAST。你也可以选择将每个点或某个子集作为关键点。直接“将两个Kinect数据集输入到对应关系估计”中的问题在于每帧中有30万点，因此可能会有30万^2个对应关系。

### 特征描述符

基于找到的关键点，我们需要提取[特征](https://pcl.readthedocs.io/projects/tutorials/en/master/how_features_work.html)，通过将信息组装生成向量进行比较。同样，PCL提供了多种特征选项，如NARF、FPFH、BRIEF或SIFT。

### 对应关系估计

给定两个来自不同扫描的特征向量集，我们需要找到对应的特征，以找到数据中的重叠部分。根据特征类型，我们可以使用不同的方法来找到对应关系。

对于**点匹配**（使用点的XYZ坐标作为特征），针对有序和无序数据存在不同的方法：

- 暴力匹配，
- kd-tree最近邻搜索（FLANN），
- 在有序数据的图像空间中搜索，
- 在有序数据的索引空间中搜索。

对于**特征匹配**（不使用点的坐标，而是某些特征），仅存在以下方法：

- 暴力匹配和
- kd-tree最近邻搜索（FLANN）。

在搜索之外，还区分了两种类型的对应关系估计：

- 直接对应关系估计（默认）：在A云的每个点中搜索B云中的对应点；
- “互惠”对应关系估计：从A云到B云中搜索对应关系，反之亦然，并仅使用交集。

### 对应关系拒绝

显然，并非所有估计的对应关系都是正确的。由于错误的对应关系可能会对最终变换的估计产生负面影响，因此它们需要被拒绝。这可以通过使用RANSAC或者仅使用找到的对应关系的一定百分比来实现。

...如果传感器数据足够相似，大多数对应关系应指向正确方向。为了过滤掉错误结果，我们会进行异常值拒绝。

一个特殊情况是一对多的对应关系，即模型中的一个点对应源中的多个点。可以通过仅使用最小距离的那个或者检查附近的其他匹配点来过滤这些情况。

### 变换估计

最后一步是实际计算变换。

- 基于对应关系评估某些误差度量；
- 估计相机姿态之间的（刚性）变换（运动估计）并最小化误差度量；
- 优化点的结构；
- 示例：
  - 使用SVD进行运动估计；
  - 使用不同核函数的Levenberg-Marquardt进行运动估计；
- 使用刚性变换将源旋转/平移到目标上，并可能在内部运行ICP循环，使用全部点、某个子集或关键点；
- 迭代直到满足某些收敛标准。

### 示例管道

#### 最近点迭代算法
1) 搜索对应关系。
2) 拒绝错误的对应关系。
3) 使用好的对应关系估计变换。
4) 迭代。

#### 基于特征的配准
1) 使用SIFT关键点（pcl::SIFT...）
2) 在关键点处使用FPFH描述符（pcl::FPFHEstimation）（参见我们的教程，如[http://www.pointclouds.org/media/rss2011.html](http://www.pointclouds.org/media/rss2011.html)）
3) 获取FPFH描述符并使用pcl::CorrespondenceEstimation估计对应关系。
4) 使用一个或多个pcl::CorrespondenceRejectionXXX方法拒绝错误的对应关系。
5) 最终获得如上所述的变换。

### 示例1：办公室场景，Kinect数据
------------------------------------

### 示例2：户外场景，激光（Riegl）数据
--------------------------------------------

### 示例3：室内场景，激光（SICK）数据
-------------------------------------------